# ___Разработка прототипа модуля для определения по данным ДЗЗ мест произрастания борщевика Сосновского___

## _Установка_
На сервере необходимо наличие установленных программных обеспечений:
 - SAGA GIS;
 - MongoDb.

## _Реализация базы данных_

#### Таблица 1. - Структура информации о файле `FilesInformation`
поле | Тип | Описание
:----|:-----------|--------:
_id | ObjectId | Идентификатор файла
FileName | String | Имя файла
MIME-type | String | MIME-тип файла
LastModified | Int64 | Дата и время последнего изменения
FileStreamId | ObjectId | Идентификатор потока файла, который связан с таблицой "fs.files"

#### Таблица 2. - Структура потока файла `fs.files`
Поле | Тип | Описание
:----|:-----------|--------:
_id | ObjectId | Идентификатор потока файла
length | Int64 | Размер файла \[МБ]
chunkSize | Int32 | Размер чанки
uploadDate | Date | Дата и время загрузки в БД
md5 | String | 128-битный алгоритм хеширования[^1]
filename | String | Имя файла

## _Описание алгоритма по шагам_
1. Наш внешний сервис вызывает метод `CreateFile` по HTTP с параметром `fileInfo` для действия контроллера `HttpPost`. Этот параметр `fileInfo` включает данные(идентификатор файла(id), имя файла, MIME-тип файла, дату и время последнего изменеия, идентификатор потока файла)  
  
  1.1. Эти данные записываюся в БД `MongoDb`, и идентификатор файла генерируется  
  
  1.2. Кэш создается с ключом "fileKey", в него также записываются эти данные, срок его действия составляет 30сек, а размер ограничен 16  
  
  1.3. Проверяется правильность id, Если истина, то возвращается статус 200 и идентификатор для загрузки на сервер. В противном случае возвращается 404 и сообщение об ошибке _"Ошибка запроса при выборе файла. Идентификатор выбранного файла неверен."_  
  
2. Внешний сервис вызывает метод `Upload` по HTTP с параметром `id` для действия контроллера `HttpPut`. Этот параметр включает идентификатор загрузки полученный при вызове `CreateFile`  
  
  2.1. Если типом контента запроса не является MIME-тип файла `application/octet-stream`[^2], то возвращается статус 400 и сообщение об ошибке _"Этот тип контента запроса не подерживается"_  
  
  2.2. Если id является некорректным, то возвращается 400 и сообщение об ошибке _"Ошибка запроса при загрузке файла. Полученный при вызове CreateFile идентификатор загрузки файла некорректный."_  
  
  2.3. Если не существует кэша с ключом "fileKey", то информация о выбранном файле придется читать из БД `MongoDb`  
  
  2.4. Информация о выбранном файле проверяется на пустость, затем возвращается статус 404 и сообщение об ошибке _"Что-то пошло не так."_  
  
  2.5. Тело запроса, назначенное потоку файла, загружается в БД `MongoDb`  
  
  2.6. При сохранении потока файла будет сгенерирован идентификатор потока файла  
  
  2.7. Возвращается статус 200   
  
3. Внешний сервис вызывает по HTTP метод `StartProcess`. Этот метод, являющийся действием контроллера `HttpPut`  
  
  3.1. Запускается новый процесс из командной строки путем указания имени командного файла `script.bat`  
  
  3.2. Формируется данный файл, в котором указывается:  
  
  3.2.1. Изменение полной пути к данному файлу выполняемого скрипта;  
  
  3.2.2. Переход в предыдущий каталог;  
  
  3.2.3. Создание каталога `Storage`, если не существует;  
  
  3.2.4. Переход в каталог `Storage`.  


[Вверх](#разработка-прототипа-модуля-для-определения-по-данным-ДЗЗ-мест-произрастания-борщевика-сосновского)

[^1]: MongoDB автоматически генерирует и хранит MD5 хеш файла. Это удобно для сравнения загруженных файлов по MD5 хешу и обнаружения дубликатов или валидации успешной загрузки.
[^2]: Любым файлом может быть подтип octet-stream. Это значит, что файл передаётся потоком. Подтип «октет-поток» используется для указания того, что тело содержит произвольные двоичные данные.