# ___Разработка модуля для определения по данным ДЗЗ мест произрастания борщевика Сосновского___

## _Установка_
На сервере необходимо наличие установленного программного обеспечения SAGA GIS.  
 
```
## _Реализация базы данных_

#### Табл 1. - Структура `FilesInformation`.
Таблица содержит уникальное имя файла и информацию о нём, предоставляемую при выборе. 
поле | Тип | Описание
:----|:-----------|--------:
_id | ObjectId | Идентификатор файла
filename | String | Имя файла
MIME-type | String | Тип файла
lastModified | Int64 | Дата и время последнего изменения файла
fileStream_id | ObjectId | Идентификатор потока файла, который связан с таблицой 2 "fs.files"

#### Табл 2. - Структура `fs.files`.
Таблица необходима для хранения файлов, которые предоставляют при загрузке. 
Поле | Тип | Описание
:----|:-----------|--------:
_id | ObjectId | Идентификатор потока файла
length | Int64 | Размер файла (КБ)
chunkSize | Int32 | Размер чанки (КБ)
uploadDate | Date | Дата и время загрузки
md5 | String | 128-битный алгоритм хеширования[^1]
filename | String | Имя файла
```

## _Описание алгоритма по шагам_
1. Наш внешний сервис вызывает метод `CreateFile` по HTTP в качестве параметра `fileInfo` для действия контроллера `HttpPost` класса `FileApiController`. Этот параметр `fileInfo` включает информацию о выбранном файле (идентификатор файла(id), имя файла, MIME-тип файла, дату и время последнего изменеия, идентификатор потока файла). Идентификатор файла генерируется по умалчанию.  
  
  1.1. Переменная объявляется `dataset`(Датасет) и ей присваивается значение, которое включает в себя информация о файле и спутниковые данные. Идентификатор спутниковых данных генерируется  
  
  1.2. Датасет пытается записываться в БД `PostgreSQL`  
  
  1.2.1. Если получилось записываться, то такая информация `fileInfo` также записывается в кеш в качестве ключа "file" и кешируется в памяти на 1мин(срок его действия составляет 1мин), размер ограничен 16КБ  
  
  1.2.2. Иначе возвращает 404 и сообщение об ошибке _"Ошибка при добавлении данных о файле в БД."_  
  
  1.3. Возвращает статус 201 и идентификатор файла для загрузки на сервер  
    
2. Наш внешний сервис вызывает метод `Upload` по HTTP в качестве параметра `id` для действия контроллера `HttpPut` класса `FileApiController`. Этот параметр включает идентификатор загрузки полученный при вызове `CreateFile`  
    
  2.1. Если `id` является некорректным, то возвращает 400 и сообщение об ошибке _"Ошибка запроса при загрузке файла. Полученный при вызове CreateFile идентификатор загрузки файла некорректный."_  
  
  2.2. Если типом контента запроса не является MIME-тип файла `application/octet-stream`[^2], то возвращает статус 400 и сообщение об ошибке _"Этот тип контента запроса не подерживается"_  

  2.3. Если существует кэш в качестве ключа "file", то информация о выбранном файле читает из кэша и декешируется из памяти. В противном случае такая информация придется читать из БД `PostgreSQL`  
  
  2.4. Информация о выбранном файле проверяется на пустость, затем возвращает статус 404 и сообщение об ошибке _"Что-то пошло не так."_  
  
  2.5. Тело запроса, назначенное потоку файла, загружается в БД `MongoDb` и генерируется идентификатор потока файла  
  
  2.6. Датасет пытается обновиться в БД `PostgreSQL`. Если не получилось обновиться, то возвращает 404 и сообщение об ошибке _"Не удалось загрузить файл."_  
  
  2.7. Возвращает статус 200  
  
3. Наш внешний сервис вызывает по протоколу HTTP метод `AreasDetection`, являющийся действием контроллера `HttpPut` класса `CalculationMethodController`, в качестве параметра `id`. Этот метод для работы с обнаружением территорий, поврежденных зарастанию борщевиком сосновского. Этот параметр включает идентификатор спутниковых данных полученный при вызове `Upload` или `GetSatellitesData`  
  
  3.1. Переменная `satelliteData`(спутниковые данные) объявляется и спутниковая информация читает по этому идентификатору из БД `PostgreSQL`  
  
  3.2. Если подкаталог `SatelliteImages` не существует, он создаётся  
  
  3.3. Перебор строк таблицы с объектами файлов  
  
  3.3.1. Файл выгружается из БД `MongoDb` в подкаталог  
  
  3.4. Запускается новый процесс из командной строки путем указания имени командного файла `saga_runs_calc.bat`  
  
  3.5. Формируется данный файл, в котором указывается:  
  
  3.5.1. добавление команды `saga_cmd` в системную переменную среды;
  
  3.5.2. изменение полного пути к подкаталогу `SatelliteImages`;  
  
  3.5.3. конвертация гео формата каждого файла GeoTiff в данные сетки .sdat через ПО `SAGA`;  
  
  3.5.4. калькулятор сетки, который по спектральным индексам рассчитывает новую сетку на основе существующих сеток(bands 2,3,4,5) и математических формул Роуза(Rouse) NDVI и Рыжикова HSI через ПО `SAGA`;  
  
  3.5.5. конвертация вычисленного по индексам гео формата файла .sdat в гео формат Shapefile через ПО `SAGA`;  
  
  3.5.6. добавление площади многоугольников в хранилище данного файла Shapefile через ПО `SAGA`;  
  
  3.5.7. присвоение уникального идентификатора выбранному полю ID атрибута таблицы данного файла Shapefile через ПО `SAGA`;  
    
  3.5.8. извлечение информации из выбранных сеток файла GeoTiff и её добавление в хранилище данного файла Shapefile через ПО `SAGA`;  

  3.5.9. заменение в поле "наименование" на Участок через ПО `SAGA`;  
  
  3.5.10. форматироваине текста в поле "наименование" - "Наименование ID" (Участок 1 и Участок 2 и т.д.) через ПО `SAGA`  

[Вверх](#разработка-прототипа-модуля-для-определения-по-данным-ДЗЗ-мест-произрастания-борщевика-сосновского)

[^1]: MongoDB автоматически генерирует и хранит MD5 хеш файла. Это удобно для сравнения загруженных файлов по MD5 хешу и обнаружения дубликатов или валидации успешной загрузки.
[^2]: Любым файлом может быть подтип octet-stream. Это значит, что файл передаётся потоком. Подтип «октет-поток» используется для указания того, что тело содержит произвольные двоичные данные.