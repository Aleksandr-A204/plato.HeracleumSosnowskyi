# ___Разработка прототипа модуля для определения по данным ДЗЗ мест произрастания борщевика Сосновского___

## _Установка_
На сервере необходимо наличие установленного программного обеспечения SAGA GIS.  
 
## _Реализация базы данных_

#### Табл 1. - Структура `FilesInformation`.
Таблица содержит уникальное имя файла и информацию о нём, предоставляемую при выборе. 
поле | Тип | Описание
:----|:-----------|--------:
_id | ObjectId | Идентификатор файла
filename | String | Имя файла
MIME-type | String | Тип файла
lastModified | Int64 | Дата и время последнего изменения файла
fileStream_id | ObjectId | Идентификатор потока файла, который связан с таблицой 2 "fs.files"

#### Табл 2. - Структура `fs.files`.
Таблица необходима для хранения файлов, которые предоставляют при загрузке. 
Поле | Тип | Описание
:----|:-----------|--------:
_id | ObjectId | Идентификатор потока файла
length | Int64 | Размер файла (КБ)
chunkSize | Int32 | Размер чанки (КБ)
uploadDate | Date | Дата и время загрузки
md5 | String | 128-битный алгоритм хеширования[^1]
filename | String | Имя файла

## _Описание алгоритма по шагам_
1. Наш внешний сервис вызывает метод `CreateFile` по HTTP в качестве параметра `fileInfo` для действия контроллера `HttpPost` класса `FileApiController`. Этот параметр `fileInfo` включает информацию о выбранном файле (идентификатор файла(id), имя файла, MIME-тип файла, дату и время последнего изменеия, идентификатор потока файла)  
  
  1.1. Такая информация записывается в БД `MongoDb`, и идентификатор файла генерируется  
  
  1.2. Проверяется правильность id    
  
  1.2.1. Если id является правильным, такая информация также записывается в кеш в качестве ключа "file" и кешируются в памяти на 30секунд(срок его действия составляет 30сек), размер ограничен 16КБ  
  
  1.2.2. В противном случае метод возвращает 404 и сообщение об ошибке _"Ошибка запроса при выборе файла. Идентификатор выбранного файла неверен."_
  
  1.3. Метод возвращает статус 200 и идентификатор для загрузки на сервер  
  
2. Наш внешний сервис вызывает метод `Upload` по HTTP в качестве параметра `id` для действия контроллера `HttpPut` класса `FileApiController`. Этот параметр включает идентификатор загрузки полученный при вызове `CreateFile`  
  
  2.1. Если типом контента запроса не является MIME-тип файла `application/octet-stream`[^2], то возвращает статус 400 и сообщение об ошибке _"Этот тип контента запроса не подерживается"_  
  
  2.2. Если id является некорректным, то возвращает 400 и сообщение об ошибке _"Ошибка запроса при загрузке файла. Полученный при вызове CreateFile идентификатор загрузки файла некорректный."_  
  
  2.3. Если не существует кэша в качестве ключа "file", то информация о выбранном файле придется читать из БД `MongoDb`  
  
  2.4. Информация о выбранном файле проверяется на пустость, затем возвращает статус 404 и сообщение об ошибке _"Что-то пошло не так."_  
  
  2.5. Тело запроса, назначенное потоку файла, загружается в БД `MongoDb`  
  
  2.6. При сохранении потока файла будет сгенерирован идентификатор потока файла  
  
  2.7. Возвращает статус 200   
  
3. Наш внешний сервис вызывает по HTTP метод `StartsCalculate`, являющийся действием контроллера `HttpPut` класса `CalculationMethodController`. Этот метод для работы со снимками территории в ПО SAGA  
  
  3.1. Запускается новый процесс из командной строки путем указания имени командного файла `script.bat`  
  
  3.2. Формируется данный файл, в котором указывается:  
  
  3.2.1. Изменение полной пути к данному файлу выполняемого скрипта;  
  
  3.2.2. Переход в предыдущий каталог;  
  
  3.2.3. Создание каталога `Storage`, если не существует;  
  
  3.2.4. Переход в каталог `Storage`.  


[Вверх](#разработка-прототипа-модуля-для-определения-по-данным-ДЗЗ-мест-произрастания-борщевика-сосновского)

[^1]: MongoDB автоматически генерирует и хранит MD5 хеш файла. Это удобно для сравнения загруженных файлов по MD5 хешу и обнаружения дубликатов или валидации успешной загрузки.
[^2]: Любым файлом может быть подтип octet-stream. Это значит, что файл передаётся потоком. Подтип «октет-поток» используется для указания того, что тело содержит произвольные двоичные данные.