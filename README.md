# Разработка прототипа модуля для определения по данным ДЗЗ мест произрастания борщевика Сосновского
### Описание алгоритма расчета по шагам.

1. Наш внешний сервис вызывает по HTTP метод такой-то, 
2. Данные записываются туда то
3. Формируется кмд файл в котором указывается то-то и то-то

# Платформа «Плато»

### Установка
На сервере необходимо наличие установленного Docker.
Скрипт автоматического запуска работает с помощью systemd. Если ваша система использует другую систему инициализации,
настройте ее на запуск и остановку контейнеров согласно командам ниже.

* Инструкция по установке Docker: https://docs.docker.com/engine/install/
* Инструкция по установке Docker Compose: https://docs.docker.com/compose/install/

1. В директории дистрибутива нужно выполнить следующие команды:
```bash
chmod +x ./install.sh
sudo ./install.sh
```

1. После выполнения скрипта `install.sh` необходимо выполнить запуск платформы (первый запуск может занять некоторое время):
```bash
service plato start
```

1. Чтобы выполнить остановку платформы нужно выполнить:
```bash
service plato stop
```

### Диагностика запуска

Контроль запуска производится командой

```
docker ps
```

Контейнеры служб плато при запуске перезапускаются несколько раз - это нормально, они ожидает поднятия БД.

При успешном запуске веб-интерфейс платформы открывается по порту 8080.

При необходимости проверки сообщений запуска компонентов выполнить

```
cd /opt/plato
docker-compose down
docker-compose up
```

Сообщения о запуске компонентов начнут выводиться в консоль. 
После окончания диагностики остановить систему (`Ctr+C`) и запустить штатно.

### Просмотр логов
Утилита просмотра логов доступна по адресу `https://localhost:9098` из локальной сети.

### Резервное копирование
Чтобы выполнить резервное копирование нужно выполнить следующие команды из директории дистрибутива:
```bash
cd scripts
chmod +x ./backup.sh
sudo ./backup.sh
```

В результате будет создана директория бэкапа по пути `/opt/plato/dump`.

### Восстановление из резервной копии
Чтобы выполнить восстановление нужно выполнить следующие команды из директории дистрибутива:
```bash
cd scripts
chmod +x ./restore.sh
sudo ./restore.sh <директория папки бэкапа>
```
Например:
```bash
cd scripts
chmod +x ./restore.sh
sudo ./restore.sh /opt/plato/dump/20220617T1659_backup
```
В ходе восстановления могут возникнуть незначительные ошибки не влияющие на работоспособность системы.

### Настройка LDAP

По умолчанию в системе используется авторизация при помощи локальных пользователей. Если необходимо осуществлять вход с помощью внешнего LDAP-сервера, то необходимо настроить в конфигурационном файле системы параметры LDAP-сервера. После выполнения настройки система перейдет в смешанный режим авторизации: если при входе пользователя по введенным имени пользователя и паролю обнаруживается локальный пользователь, то используется он. Если обнаруживается пользователь с флагом авторизации LDAP, то его учетные данные проверяются на сервере авторизации. В системе автоматически появляется запись о пользователе при успешной авторизации нового пользователя LDAP по введенным учетным данным.
Настройки LDAP в файле authentication.env для ActiveDirectory. Чтобы активировать настройки LDAP необходимо в docker-compose.yml раскоментировать строку
```yaml
# env_file: authentication.env
```

```
# LDAP
# ----
LDAP__Enabled=true # Включение интеграции LDAP
LDAP__Host="localhost" # LDAP сервер
LDAP__Port=389 # Порт LDAP сервера (389/636)
LDAP__Username="" # Пользователь для поиска в LDAP
LDAP__Password="" # Пароль пользователя для поиска в LDAP
LDAP__BaseDn="dc=example,dc=org" # Путь поиска пользователей и групп
LDAP__GroupFilter="(&(objectCategory=user)(sAMAccountName={0}))" # Фильтр для поиска пользователя (в {0} будет подставлено имя пользователя со страницы входа)
LDAP__FirstNameAttribute="givenName" # Поле "Имя"
LDAP__SecondNameAttrubute="sn" # Поле "Фамилия"
LDAP__EmailAttribute="mail" # Поле "Email"
LDAP__NewUserRoleName="Гость" # Роль по-умолчанию для пользователей из LDAP
```

### Настройка доменного имени и https
Для настройки работы «Плато» по протоколу https с использованием сертификатов организации, необходимо сконфигурировать обратное проксирование при помощи отдельного web-сервера организации. На примере сервера nginx конфигурация выглядит следующим образом:
1. Допустим платформа установлена на сервере по адресу `123.124.122.111:8080`
1. Необходимо настроить работу платформы на домене `https://example.com`
```
server {
   listen 443; # внешний порт https
   server_name example.com; # домен
   client_max_body_size 1000M;
 
   ssl on; # активация https
   ssl_certificate /etc/letsencrypt/live/infolan.org/fullchain.pem; # сертификат
   ssl_certificate_key /etc/letsencrypt/live/infolan.org/privkey.pem; # ключ сертификата
 
   ssl_session_timeout 5m;
 
   ssl_protocols SSLv3 TLSv1 TLSv1.1 TLSv1.2;
   ssl_ciphers "HIGH:!aNULL:!MD5 or HIGH:!aNULL:!MD5:!3DES";
   ssl_prefer_server_ciphers on;
 
   location / {
       proxy_pass http://123.124.122.111:8080; # адрес внутреннего сервера
       proxy_set_header X-Real-IP $remote_addr;
       proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
       proxy_set_header Host $http_host;
   }
```


[Вверх](#разработка-прототипа-модуля-для-определения-по-данным-ДЗЗ-мест-произрастания-борщевика-сосновского)